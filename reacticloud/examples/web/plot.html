<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script type="text/javascript" src="./reacticloud.js"></script>
  <script type="text/javascript" src="./plot.js"></script>
  <script type="text/javascript" src="./plothelper_compiled.js"></script>
  <script type="text/javascript" src="./parse_csv.js"></script>

  <script type="text/javascript">
    function example1() {
      const csvUrlElem = document.getElementById('csv_url')
      const xColumnElem = document.getElementById('x_column')
      const yColumnElem = document.getElementById('y_column')
      csvUrlElem.value = 'https://gist.githubusercontent.com/donald-pinckney/6bf75b5ec7ac8a24cfd1dd9f2ac839af/raw/7efc3ada1fea6395b79b580f544c916421af11a3/cali.csv'
      xColumnElem.value = 'Latitude'
      yColumnElem.value = 'MedInc'
    }

    function example2() {
      const csvUrlElem = document.getElementById('csv_url')
      const xColumnElem = document.getElementById('x_column')
      const yColumnElem = document.getElementById('y_column')
      csvUrlElem.value = 'https://gist.githubusercontent.com/donald-pinckney/21366b33a124006f73750066df0aad88/raw/d408deb4d94e652e9d18b0568181a806ad317a5b/iris.csv'
      xColumnElem.value = 'sepal length (cm)'
      yColumnElem.value = 'sepal width (cm)'
    }

    function setupSF() {
      const plotBtn = document.getElementById('plotBtn')
      const plotElem = document.getElementById('plot')
      const csvUrlElem = document.getElementById('csv_url')
      const xColumnElem = document.getElementById('x_column')
      const yColumnElem = document.getElementById('y_column')
      const plotTimeElem = document.getElementById('plot_time')

      const SF = reacticloud.SF

      

      const getCSVStr = SF.arrAsync((url, done) => {
        fetch(url, {redirect: 'follow'}).then((response) => response.text()).then((textBody) => done(textBody))
      }, 'cloud')

      const csvParse = SF.arrAsync((csv, done) => {
        return parse_csv(csv, {columns: true, skip_empty_lines: true}, (err, records) => {
          done(records)
        })
      })

      const extractColumns = SF.arr(([data, [x_col, y_col]]) => {
        const xs = data.map((record) => {
          return record[x_col]
        })
        const ys = data.map((record) => {
          return record[y_col]
        })
        const pair = [xs, ys]
        return pair
      })

      const makePlot = SF.arrAsync(([[xs, ys], [x_name, y_name]], done) => {
        plot(xs, ys, x_name, y_name, 1000, 1000, (buffer) => {
          done(buffer)
        })
      }, 'cloud')

      let clickTime = null

      const final_sf = getCSVStr
        .then(csvParse)
        .first()
        .then(extractColumns.and(SF.p2()))
        .then(makePlot)
        .subscribe(imageData => {
          const dt = Date.now() - clickTime
          plotTimeElem.innerText = `Plotted in ${dt} ms`
          plotElem.src = imageData
          // console.log(imageData)
        })
        

      // reacticloud.deploy("localhost", 3000, final_sf).then(runnable => {
      reacticloud.deploy("vdi-linux-045.ccs.neu.edu", 12000, final_sf).then(runnable => {
        plotBtn.onclick = () => {
          plotTimeElem.innerText = 'Fetching data and plotting...'
          const csvUrl = csvUrlElem.value
          const xName = xColumnElem.value
          const yName = yColumnElem.value
          clickTime = Date.now()
          runnable([csvUrl, [xName, yName]])
        }
      })

      // plot([2, 3, 4], [3, 5, 2], 'X axis', 'Y axis', 400, 400, (buffer) => {
      //   // console.log(buffer)
      //   document.getElementById('plot').src = buffer
      // })

    }
  </script>
</head>
<body onload="setupSF()">

  <button onclick="example1()">Example Plot 1</button>
  <button onclick="example2()">Example Plot 2</button>
  <br />
  
  URL of a CSV file:
  <textarea cols="100" id="csv_url"></textarea>
  <br />
  X Column:
  <input type="text" id="x_column" />
  <br />
  Y Column:
  <input type="text" id="y_column" />
  <br />
  <button id="plotBtn">Plot!</button>
  <br />
  <p id='plot_time'>

  </p>
  <br />
  <img id="plot" src="">
  <br />
  <!-- <canvas id="canvas" height="400" width="400"></canvas> -->
</body>
</html>